---
title: "Relatório Indicadores Escolares de Saude 2023-2024"
author: "Grupo 2"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: yeti
    highlight: tango
    code_folding: show
    df_print: paged
---

```{r setup, include=FALSE}
pacman::p_load(tidyverse, readxl, ggplot2, scales, kableExtra)
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
```

# Introdução
Este relatório apresenta indicadores escolares referentes ao período de 2023-2024, incluindo número de escolas, educandos, atividade.......

# Dados
## Leitura
```{r leitura-dados}
atividade_municipio <- read_excel("atividades_pse_2023_numerador.xlsx")  %>% #Numerador (Numero de atividades em escolas por municipio)
  rename(municipio = Municipio) 

escolas_adesao <- read_excel("escolas_pse_adesao_2023_2024_denominador.xlsx") %>% #Denominador (Numero de escolas por municipio)
  rename(municipio = MUNICIPIO) 

```
## Criando DataFrame das Regioes e UFs

```{r}
# Criar vetor com as UFs e Regiões correspondentes
uf <- c("AC", "AL", "AM", "AP", "BA", "CE", "DF", "ES", "GO", "MA", "MT", "MS", 
        "MG", "PA", "PB", "PR", "PE", "PI", "RJ", "RN", "RS", "RO", "RR", "SC", 
        "SE", "SP", "TO")

regiao <- c("Norte", "Nordeste", "Norte", "Norte", "Nordeste", "Nordeste", "Centro-Oeste", 
            "Sudeste", "Centro-Oeste", "Nordeste", "Centro-Oeste", "Centro-Oeste", 
            "Sudeste", "Norte", "Nordeste", "Sul", "Nordeste", "Nordeste", "Sudeste", 
            "Nordeste", "Sul", "Norte", "Norte", "Sul", "Nordeste", "Sudeste", "Norte")

# Criar o data frame
uf_regiao <- data.frame(UF = uf, regiao = regiao, stringsAsFactors = FALSE)

# Visualizar o data frame
print(uf_regiao)

```


## Tratamento

```{r}
df_escola_municipio <- escolas_adesao %>%
  group_by(municipio) %>%
  summarise(
    escolas   = n(),
    educandos = sum(`QUANTIDADE EDUCANDOS`, na.rm = TRUE),
    .groups   = "drop"
  )

df_atividades_municipio <- atividade_municipio %>%
  rename(atividade_educacao = Educação, atividade_saude = Saúde) %>%
  mutate(total_atividade = atividade_educacao + atividade_saude)

```

# Indicadores

```{r}
df_final <- left_join(df_escola_municipio, df_atividades_municipio, by = "municipio") %>%
  rename(UF = Uf) %>%
  mutate(
    razao_atividades_por_escola = total_atividade / escolas,
    razao_educando_atividade    = educandos / total_atividade
  ) %>%
  left_join(uf_regiao, by = "UF") %>%
  select(regiao, UF, municipio, Ibge, escolas, educandos,
         atividade_educacao, atividade_saude, total_atividade,
         razao_atividades_por_escola, razao_educando_atividade)

# Médias nacionais para referência
global_razao_atividade_por_escola <- sum(df_final$total_atividade, na.rm = TRUE) / sum(df_final$escolas, na.rm = TRUE)
global_razao_educando_atividade  <- sum(df_final$educandos, na.rm = TRUE) / sum(df_final$total_atividade, na.rm = TRUE)

```


# Resultados

## Razões por Região

### atividade por Escola

```{r, fig.width=10}
df_regiao_razao_atividade <- df_final %>%
  drop_na(razao_atividades_por_escola) %>%
  group_by(regiao) %>%
  summarise(
    total_escolas    = sum(escolas, na.rm = TRUE),
    total_atividade  = sum(total_atividade, na.rm = TRUE),
    .groups          = "drop"
  ) %>%
  mutate(razao_atividade_por_escola = total_atividade / total_escolas) %>%
  arrange(desc(razao_atividade_por_escola))

ggplot(df_regiao_razao_atividade, aes(
    x    = razao_atividade_por_escola,
    y    = reorder(regiao, razao_atividade_por_escola),
    fill = regiao
  )) +
  geom_col(show.legend = FALSE) +
  geom_vline(xintercept = global_razao_atividade_por_escola,
             linetype   = "dashed",
             size       = 0.7,
             color      = "black") +
  annotate("text",
           x     = global_razao_atividade_por_escola + 0.5,
           y     = Inf,
           label = paste0("Média Nacional: ", round(global_razao_atividade_por_escola, 2)),
           hjust = 0,
           vjust = 35,
           color = "black",
           size  = 4) +
  geom_text(aes(label = round(razao_atividade_por_escola, 2)),
            hjust = -0.1,
            color = "gray20",
            size  = 3.5) +
  labs(
    title    = "Taxa de Atividades por Escola por Região (2023-2024)",
    subtitle = "Número médio de atividades realizadas por escola em cada região",
    x        = "Atividades por Escola",
    y        = "Região"
  ) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title      = element_text(face = "bold", size = 16),
    plot.subtitle   = element_text(size = 12, color = "gray40"),
    axis.title      = element_text(face = "bold"),
    axis.text       = element_text(color = "gray20"),
    plot.caption    = element_text(size = 8, hjust = 1, color = "gray60"),
    plot.margin     = margin(t = 5, r = 20, b = 5, l = 5)
  )

```


```{r tabela-regiao-atividade}
df_regiao_razao_atividade %>%
  mutate(razao_atividade_por_escola = round(razao_atividade_por_escola, 2)) %>%
  kable("html", caption = "Razão de Atividades por Escola por Região (2023-2024)") %>%
  kable_styling(full_width = FALSE)

```

### Educandos por Atividade
```{r regiao-educandos,fig.width=10}
df_regiao_razao_educandos <- df_final %>%
  drop_na(razao_educando_atividade) %>%
  group_by(regiao) %>%
  summarise(
    total_educandos = sum(educandos, na.rm = TRUE),
    total_atividade = sum(total_atividade, na.rm = TRUE),
    .groups         = "drop"
  ) %>%
  mutate(razao_educando_atividade = total_educandos / total_atividade) %>%
  arrange(desc(razao_educando_atividade))

ggplot(df_regiao_razao_educandos, aes(
    x    = razao_educando_atividade,
    y    = reorder(regiao, razao_educando_atividade),
    fill = regiao
  )) +
  geom_col(show.legend = FALSE) +
  geom_vline(xintercept = global_razao_educando_atividade,
             linetype   = "dashed",
             size       = 0.7,
             color      = "black") +
  annotate("text",
           x     = global_razao_educando_atividade + 0.5,
           y     = Inf,
           label = paste0("Média Nacional: ", round(global_razao_educando_atividade, 2)),
           hjust = 0,
           vjust = 35,
           color = "black",
           size  = 4) +
  geom_text(aes(label = round(razao_educando_atividade, 2)),
            hjust = -0.1,
            color = "gray20",
            size  = 3.5) +
  labs(
    title    = "Taxa de Educandos por Atividade por Região (2023-2024)",
    subtitle = "Número médio de educandos atendidos por atividade em cada região",
    x        = "Educandos por Atividade",
    y        = "Região"
  ) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title      = element_text(face = "bold", size = 16),
    plot.subtitle   = element_text(size = 12, color = "gray40"),
    axis.title      = element_text(face = "bold"),
    axis.text       = element_text(color = "gray20"),
    plot.caption    = element_text(size = 8, hjust = 1, color = "gray60"),
    plot.margin     = margin(t = 5, r = 20, b = 5, l = 5)
  )

```
```{r tabela-regiao-educandos}
df_regiao_razao_educandos %>%
  mutate(razao_educando_atividade = round(razao_educando_atividade, 2)) %>%
  kable("html", caption = "Razão de Educandos por Atividade por Região (2023-2024)") %>%
  kable_styling(full_width = FALSE)

```

## Razões por UF
### atividade por Escola
```{r uf-atividade, fig.width=10}
df_uf_razao_atividade <- df_final %>%
  drop_na(razao_atividades_por_escola) %>%
  group_by(regiao, UF) %>%
  summarise(
    total_escolas    = sum(escolas, na.rm = TRUE),
    total_atividade  = sum(total_atividade, na.rm = TRUE),
    .groups          = "drop"
  ) %>%
  mutate(razao_atividade_por_escola = total_atividade / total_escolas) %>%
  arrange(desc(razao_atividade_por_escola))

ggplot(df_uf_razao_atividade, aes(
    x    = razao_atividade_por_escola,
    y    = reorder(UF, razao_atividade_por_escola),
    fill = regiao
  )) +
  geom_col() +
  geom_vline(xintercept = global_razao_atividade_por_escola,
             linetype   = "dashed",
             size       = 0.7,
             color      = "black") +
  annotate("text",
           x     = global_razao_atividade_por_escola + 0.3,
           y     = Inf,
           label = paste0("Média Nacional: ", round(global_razao_atividade_por_escola, 2)),
           hjust = 0,
           vjust = 35,
           color = "black",
           size  = 3.5) +
  geom_text(aes(label = round(razao_atividade_por_escola, 2)),
            hjust = -0.1,
            color = "gray20",
            size  = 3) +
  labs(
    title    = "Taxa de Atividades por Escola por UF (2023-2024)",
    subtitle = "Número médio de atividades realizadas por escola em cada Unidade Federativa",
    x        = "Atividades por Escola",
    y        = "UF",
    fill     = "Região"
  ) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title      = element_text(face = "bold", size = 16),
    plot.subtitle   = element_text(size = 12, color = "gray40"),
    axis.title      = element_text(face = "bold"),
    axis.text       = element_text(color = "gray20"),
    legend.title    = element_text(face = "bold"),
    legend.position = "right",
    plot.caption    = element_text(size = 8, hjust = 1, color = "gray60"),
    plot.margin     = margin(t = 5, r = 20, b = 5, l = 5)
  )

```

```{r tabela-uf-atividade}
df_uf_razao_atividade %>%
  mutate(razao_atividade_por_escola = round(razao_atividade_por_escola, 2)) %>%
  select(UF, regiao, razao_atividade_por_escola) %>%
  kable("html", caption = "Razão de Atividades por Escola por UF (2023-2024)") %>%
  kable_styling(full_width = FALSE)

```

### Educandos por atividade
```{r uf-educandos, fig.width=10}
df_uf_razao_educandos <- df_final %>%
  drop_na(razao_educando_atividade) %>%
  group_by(regiao, UF) %>%
  summarise(
    total_educandos = sum(educandos, na.rm = TRUE),
    total_atividade = sum(total_atividade, na.rm = TRUE),
    .groups         = "drop"
  ) %>%
  mutate(razao_educando_atividade = total_educandos / total_atividade) %>%
  arrange(desc(razao_educando_atividade))

ggplot(df_uf_razao_educandos, aes(
    x    = razao_educando_atividade,
    y    = reorder(UF, razao_educando_atividade),
    fill = regiao
  )) +
  geom_col() +
  geom_vline(xintercept = global_razao_educando_atividade,
             linetype   = "dashed",
             size       = 0.7,
             color      = "black") +
  annotate("text",
           x     = global_razao_educando_atividade + 0.3,
           y     = Inf,
           label = paste0("Média Nacional: ", round(global_razao_educando_atividade, 2)),
           hjust = 0,
           vjust = 35,
           color = "black",
           size  = 3.5) +
  geom_text(aes(label = round(razao_educando_atividade, 2)),
            hjust = -0.1,
            color = "gray20",
            size  = 3) +
  labs(
    title    = "Taxa de Educandos por Atividade por UF (2023-2024)",
    subtitle = "Número médio de educandos atendidos por atividade em cada Unidade Federativa",
    x        = "Educandos por Atividade",
    y        = "UF",
    fill     = "Região"
  ) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title      = element_text(face = "bold", size = 16),
    plot.subtitle   = element_text(size = 12, color = "gray40"),
    axis.title      = element_text(face = "bold"),
    axis.text       = element_text(color = "gray20"),
    legend.title    = element_text(face = "bold"),
    legend.position = "right",
    plot.caption    = element_text(size = 8, hjust = 1, color = "gray60"),
    plot.margin     = margin(t = 5, r = 20, b = 5, l = 5)
  )

```
```{r tabela-uf-educandos}
df_uf_razao_educandos %>%
  mutate(razao_educando_atividade = round(razao_educando_atividade, 2)) %>%
  select(UF, regiao, razao_educando_atividade) %>%
  kable("html", caption = "Razão de Educandos por Atividade por UF (2023-2024)") %>%
  kable_styling(full_width = FALSE)

```




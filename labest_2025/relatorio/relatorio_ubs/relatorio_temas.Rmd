---
title: "Relatório de Indicadores de Temas de Saúde 2023"
author: "Grupo 2"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: yeti
    highlight: tango
    code_folding: show
    df_print: paged
---

```{r setup, include=FALSE}
pacman::p_load(tidyverse, readxl, scales, kableExtra)
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
```

#  Introdução
Este relatório apresenta indicadores relativos a cinco temas de saúde (saúde bucal, alimentação saudável, saúde sexual e reprodutiva, saúde mental e autocuidado de pessoas com doenças crônicas) em níveis municipal, estadual, regional e nacional.

#  Metodologia

##  Fontes de dados
- **temas_municipio_2023.xlsx**: contêm os valores absolutos por município para cada tema.
- **pop_cadastrada_2023_denominador_temas_e_praticas.xls**: população cadastrada por município (denominador).

##  Cálculo dos indicadores
Para cada unidade territorial, calculamos indicadores individuais dividindo o valor de cada tema pela população cadastrada, e um indicador composto (total) pela soma dos cinco temas sobre a população cadastrada.

#  Indicadores Municipais

## Cálculo
```{r}
# Leitura e seleção

# temas: limpa e padroniza nomes e seleciona colunas de interesse
temas <- read_excel("temas_municipio_2023.xlsx") %>%
  janitor::clean_names() %>%
  # seleciona variáveis de interesse já em snake_case
  select(uf, ibge, municipio,
         saude_bucal, alimentacao_saudavel,
         saude_sexual_e_reprodutiva, saude_mental,
         autocuidado_de_pessoas_com_doe)

# pop: limpa nomes e renomeia conforme formato do usuário
pop <- read_excel("pop_cadastrada_2023_denominador_temas_e_praticas.xls") %>%
  janitor::clean_names() %>%
  rename(
    pop_total = qt_total_de_cadastros_limitado_pela_populacao_ibge
  )

# Junta e calcula indicadores
mun <- temas %>%
  left_join(pop, by = "ibge") %>%
  drop_na() %>%
  mutate(total_temas = saude_bucal + alimentacao_saudavel + saude_sexual_e_reprodutiva +
                 saude_mental + autocuidado_de_pessoas_com_doe,
    across(
      .cols = c(saude_bucal, alimentacao_saudavel,
                saude_sexual_e_reprodutiva, saude_mental,
                autocuidado_de_pessoas_com_doe),
      .fns = ~ (.x / pop_total)*100000, #a cada 100.000 habitantes
      .names = "ind_{.col}"
    ),
    ind_total = (total_temas / pop_total)*100000 #a cada 100.000 habitantes
  ) %>%
  mutate(
    across(
      .cols = starts_with("ind_"),
      .fns = ~ format(round(.x, 3), nsmall = 3)
    )
  ) 

# Definição manual das regiões
ufs_norte <- c("AC","AP","AM","PA","RO","RR","TO")
ufs_nordeste <- c("MA","PI","CE","RN","PB","PE","AL","SE","BA")
ufs_sudeste <- c("SP","RJ","ES","MG")
ufs_sul <- c("PR","RS","SC")
ufs_centro <- c("MT","MS","GO","DF")

# Adicionando a coluna 'regiao' ao data frame 'mun'
mun <- mun %>%
  mutate(regiao = case_when(
    uf.x %in% ufs_norte    ~ "Norte",
    uf.x %in% ufs_nordeste ~ "Nordeste",
    uf.x %in% ufs_sudeste  ~ "Sudeste",
    uf.x %in% ufs_sul      ~ "Sul",
    uf.x %in% ufs_centro   ~ "Centro-Oeste"
  )) %>%
  select(
    regiao, uf = uf.x, municipio = municipio.x, ibge, pop_total,
    saude_bucal, alimentacao_saudavel, saude_sexual_e_reprodutiva,
    saude_mental, autocuidado_de_pessoas_com_doe,total_temas,
    starts_with("ind_")
  )
```


```{r}
# Exibe tabela resumo municipal
mun %>%
  arrange(desc(ind_total)) %>%
  slice_head(n = 10) %>%
  kable("html", caption = "Indicadores por Municipio") %>%
  kable_styling()
```

## Gráfico
```{r, fig.width=12, fig.height=6}
top_10_mun <- mun %>%
  slice_max(ind_total, n = 10) %>% arrange(desc(ind_total)) %>%
  mutate(
    mun_uf    = paste0(municipio, " - ", uf),
    ind_total = as.numeric(ind_total)
  )

indicador_global <- (sum(mun$total_temas) / sum(mun$pop_total)) * 100000
max_ind <- max(top_10_mun$ind_total, na.rm = TRUE)

ggplot(top_10_mun, aes(
    x    = reorder(mun_uf, ind_total),
    y    = ind_total,
    fill = regiao
  )) +
  geom_col() +
  geom_text(aes(label = round(ind_total, 1)), hjust = -0.1, size = 3.5) +
  coord_flip(expand = FALSE) +
  scale_y_continuous(
    limits = c(0, max_ind * 1.2),
    breaks = pretty_breaks(n = 7),
    labels = comma
  ) +
  scale_fill_brewer(palette = "Set2", name = "Regiao") +
  labs(
    x     = "Municipio - UF",
    y     = "Indicador Total",
    title = "Top 10 Municipios por Indicador Total"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.margin     = margin(t = 5, r = 20, b = 5, l = 5)
  ) +
  geom_hline(aes(yintercept = indicador_global),
             color    = "black",
             linetype = "dashed",
             size     = 1) +
  annotate("text", x = 0, y = indicador_global,
           label = paste("Indicador Global: ", round(indicador_global, 3)),
           hjust = -3, vjust = -2, color = "black")


```


#  Indicadores Estaduais

## Cálculo
```{r}

# Supondo que 'mun' já esteja definido conforme o código anterior

# Agrupando por UF e recalculando os valores de forma eficiente
uf_summary <- mun %>%
  group_by(uf) %>%
  summarise(
    across(c(pop_total, saude_bucal, alimentacao_saudavel, saude_sexual_e_reprodutiva,
             saude_mental, autocuidado_de_pessoas_com_doe, total_temas), sum, na.rm = TRUE)
  ) %>%
  mutate(regiao = case_when(
    uf %in% ufs_norte    ~ "Norte",
    uf %in% ufs_nordeste ~ "Nordeste",
    uf %in% ufs_sudeste  ~ "Sudeste",
    uf %in% ufs_sul      ~ "Sul",
    uf %in% ufs_centro   ~ "Centro-Oeste"
  )) %>% 
  select(regiao,uf,pop_total, saude_bucal, alimentacao_saudavel, saude_sexual_e_reprodutiva,
             saude_mental, autocuidado_de_pessoas_com_doe, total_temas) %>%
  mutate(
    across(c(saude_bucal, alimentacao_saudavel, saude_sexual_e_reprodutiva,
             saude_mental, autocuidado_de_pessoas_com_doe, total_temas),
           ~ (.x / pop_total)*100000,
           .names = "ind_{.col}")
  )

# Exibindo o data frame resultante
print(uf_summary)
```


```{r}
uf_summary %>%
  arrange(desc(ind_total_temas)) %>%
  kable("html", caption = "Indicadores por Estado") %>%
  kable_styling(full_width = FALSE)
```

## Gráfico
```{r,fig.width=9, fig.height=5}
# recalcula global
indicador_global <- (sum(uf_summary$total_temas) / sum(uf_summary$pop_total)) * 100000

# maior valor para ajuste de espaço
max_val <- max(uf_summary$ind_total_temas, na.rm = TRUE)

ggplot(uf_summary, aes(
    x    = reorder(uf, ind_total_temas),
    y    = ind_total_temas,
    fill = regiao
  )) +
  geom_col() +
  geom_text(
    aes(label = round(ind_total_temas, 1)),
    hjust = -0.1,
    size  = 3
  ) +
  coord_flip(clip = "off") +
  scale_y_continuous(
    limits = c(0, max_val * 1.15),
    expand = expansion(mult = c(0, 0)),
    labels = comma
  ) +
  geom_hline(
    yintercept = indicador_global,
    color      = "black",
    linetype   = "dashed",
    size       = 1
  ) +
  annotate(
    "text",
    x     = 0,
    y     = indicador_global,
    label = paste("Indicador Global: ", round(indicador_global, 3)),
    hjust = -0.5, vjust = -0.5,
    color = "black"
  ) +
  labs(
    x     = "Estado (UF)",
    y     = "Indicador Total",
    title = "Indicador Total por Estado"
  ) +
  theme_minimal()
```

#  Indicadores Regionais

##  Mapeamento de regiões
```{r}

# Agrupando por região e recalculando os valores de forma eficiente
reg <- mun %>%
  group_by(regiao) %>%
  summarise(
    across(c(pop_total, saude_bucal, alimentacao_saudavel, saude_sexual_e_reprodutiva,
             saude_mental, autocuidado_de_pessoas_com_doe, total_temas), sum, na.rm = TRUE)
  ) %>%
  mutate(
    across(c(saude_bucal, alimentacao_saudavel, saude_sexual_e_reprodutiva,
             saude_mental, autocuidado_de_pessoas_com_doe, total_temas),
           ~ (.x / pop_total)*100000,
           .names = "ind_{.col}")
  )
```


```{r}
# Exibindo o data frame resultante
reg %>%
  arrange(desc(ind_total_temas)) %>%
  kable("html", caption = "Indicadores por Regiao") %>%
  kable_styling(full_width = FALSE)
```

## Gráfico
```{r,fig.width=9, fig.height=5}
# recalcula global
indicador_global <- (sum(reg$total_temas) / sum(reg$pop_total)) * 100000

# maior valor para ajustar espaço
max_val <- max(reg$ind_total_temas, na.rm = TRUE)

ggplot(reg, aes(
    x = reorder(regiao, ind_total_temas),
    y = ind_total_temas
  )) +
  geom_col(fill = "steelblue") +           # fill fora do aes(), cor fixa azul
  geom_text(
    aes(label = round(ind_total_temas, 1)),
    hjust = -0.1,
    size  = 3
  ) +
  coord_flip(clip = "off") +
  scale_y_continuous(
    limits = c(0, max_val * 1.15),
    expand = expansion(mult = c(0, 0)),
    labels = comma
  ) +
  geom_hline(
    yintercept = indicador_global,
    color      = "black",
    linetype   = "dashed",
    size       = 1
  ) +
  annotate(
    "text",
    x     = 0,
    y     = indicador_global,
    label = paste("Indicador Global: ", round(indicador_global, 3)),
    hjust  = 1.1,
    vjust  = -0.5,
    color  = "black"
  ) +
  labs(
    x     = "Regiao",
    y     = "Indicador Total",
    title = "Indicador Total por Regiao"
  ) +
  theme_minimal() +
  theme(
    plot.margin = margin(t = 5, r = 20, b = 5, l = 5)
  )

```

